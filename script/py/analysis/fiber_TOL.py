from lib.MyLumerical.LumAPI import *
import lumapi
import matplotlib.pyplot as plt
import time
import math


fiberTOL_path = 'D:/final/0619_APOUNI_0.44/fixed/fiber_TOL'
fdtd = lumapi.FDTD()
ce = []
wl = [w for w in range(1530, 1570+1, 5)]
colors = {"-6":"-r", "-4":"-y", "-2":"-g", "0":"-b", "2":"-m", "4":"-c", "6":"-k"}

for dt in range(-6, 6+1, 2):
    ce_ = []
    for w in wl:
        fdtd.load(f'{fiberTOL_path}/dtheta{dt}_lambda{w}.fsp')
        run_lsf_in_fdtd(fdtd, "E:/degree_thesis/script/lsf/PDL_Analysis.lsf")
        ce_.append(10 * math.log10(get_value_from_fdtd(fdtd, "CE2")))
        time.sleep(5)
    ce.append(ce_)
    plt.plot(wl, ce_, colors[f"{dt}"], label=f"{dt} deg.")

plt.title("CE of fiber with error tilt angle")
plt.xlim(1530, 1570)
plt.xlabel("wavelength (nm)")
plt.ylabel("CE (dB)")
plt.legend(loc="lower center")
plt.show()
plt.clf()

print(wl)
print(ce)

"""
E:\degree_thesis\venv\Scripts\python.exe E:/degree_thesis/script/py/analysis/fiber_TOL.py
[1530, 1535, 1540, 1545, 1550, 1555, 1560, 1565, 1570]
[[-22.841003631749114, -19.134121034918564, -16.96873778496187, -14.905767715303062, -13.137664599816638, -11.83995510879748, -10.80989865051481, -9.979476968257371, -9.61957591037882],
 [-14.630604640317731, -11.64781740266758, -10.102187983917375, -8.690668608844334, -7.574309741247602, -6.814694470996013, -6.233122392268312, -5.802204521798336, -5.7279697336435], 
 [-8.861954668881475, -6.789461863070031, -5.810275332583698, -4.956782326902097, -4.366711166955209, -4.07594469137744, -3.9330900461995695, -3.9228601742359066, -4.24333619518796], 
 [-5.6642542753416505, -4.411525292746217, -3.933803343219235, -3.578402185375278, -3.4549987870764336, -3.61756472696321, -3.9283539739421225, -4.357885220378084, -5.13288229399553], 
 [-4.875993216032852, -4.387079743707644, -4.373637253834671, -4.500332244021152, -4.831510105850934, -5.466040722115163, -6.273165296232788, -7.190008833218695, -8.501290532091012], 
 [-6.394374238689241, -6.691921194964749, -7.135264631973946, -7.767832664868836, -8.598556574412484, -9.767015891979936, -11.153608748300105, -12.64768944049644, -14.608773631211934], 
 [-10.167392855050908, -11.358530656823042, -12.300885418640261, -13.514671449844736, -14.968646910131753, -16.797009636552566, -18.889717280835313, -21.03811966751347, -23.61341747231984]]
"""